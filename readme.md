# Тестовое задание it-доминанта

## Стек:

* ruby (2.5)

* sinatra (2.0.4)

* rufus-scheduler (3.5.2)

* redis (5.0)

## Установка:

```bash
git clone ttps://github.com/amprsnd/streams_stat_test.git
cd ./streams_stat_test
bundle
```

## Тест:
```bash
ruby ./test/api.rb
```

## Запуск:
```bash
ruby ./streams_stats.rb
```

`/watch` - принимает post-запрос с параметрами **customer_id** и **stream_id**

`/customer/:id` - принимает get-запрос с id кастомера и возвращает количество просматриваемых им потоков.
Если кастомера с таким id нет - возвращает 0.

Пример ответа: `{"count": 3}`

`/stream/:id` - принимает get-запрос с id стрима и возвращает количество просматривающих его кастомеров.
Если стрима с таким id нет - возвращает 0.

Пример ответа: `{"count": 16}`

## Включение Redis:
```ruby
# stream_stats.rb line:15
set :redis, {
  enabled: false,
  host: '127.0.0.1',
  port: 6379,
  db: 3,
  password: '',
  adapter: nil
}
```
Если `enabled = true` и переменные для подключения выставлены корректно, то данные будут писаться в redis, больше ничего настраивать не нужно.

## Нагрузочное тестирование:

Запуск:
```bash
ruby ./test/performance.rb
```
У теста есть несколько параметров, которые позволяют управлять генерируемой нагрузкой:
```ruby
# performance.rb line:12
# Test params
c = {
  uri: "http://#{app.settings.bind}:#{app.settings.port}",
  customers: 10000, # количество кастомеров которые каждые 5 секунд отправляют уведомления о просмотре стримов
  streams: 100, # Количество стримов которые "смотрят" кастомеры
  test_time: '10m', # время через которое прервётся тест
  stats_time: '30s' # Период в который запрашивается статистика по всем кастомерам и всем стримам
}
```
Что-бы увидеть в терминале статистику по всем кастомерам и стримам в `performance.rb` нужно раскомментировать все `puts`, закомментировал их что-бы вывод не тормозил тест при большом количестве запросов.

Этим тестом удалось имитировать большое количество запросов, но не знаю насколько он приближен к реальности, т.к. для снятия метрик под нагрузкой в реальном времени подходящих инструментов не нашёл.

В терминале при генерировании запросов 10 000 кастомеров перегруз памяти или ЦП не наблюдал.

Задержек в обработке запросов тоже не было.

![Процессы и загрузка Памяти и ЦП (скриншот)](https://raw.githubusercontent.com/amprsnd/streams_stat_test/sinatra/readme/img1.png "Процессы и загрузка Памяти и ЦП")

![Обработка post и get запросов (скриншот)](https://raw.githubusercontent.com/amprsnd/streams_stat_test/sinatra/readme/img2.png "Обработка post и get запросов")
